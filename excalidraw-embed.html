<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Excalidraw Embed</title>
	<style>
		html,
		body,
		#root {
			height: 100%;
			margin: 0;
			background: #0f172a;
		}
		body {
			overflow: hidden;
		}
		.excalidraw {
			background: #0f172a;
		}
	</style>
</head>
<body>
	<div id="root"></div>
	<script type="module">
		import React, { useEffect, useRef } from "https://esm.sh/react@18.2.0?dev=false";
		import { createRoot } from "https://esm.sh/react-dom@18.2.0/client?dev=false";
		import { Excalidraw } from "https://esm.sh/@excalidraw/excalidraw@0.17.6?dev=false&alias=react:react@18.2.0,react-dom:react-dom@18.2.0&exports=Excalidraw";

		const MAX_BYTES = 200000;

		const normalizeAppStateForLoad = (appState) => {
			const clean = appState && typeof appState === "object" ? { ...appState } : {};
			if (clean.collaborators instanceof Map) return clean;
			const { collaborators, ...rest } = clean;
			return { ...rest, collaborators: new Map() };
		};

		const prepareAppStateForSend = (appState) => {
			const clean = appState && typeof appState === "object" ? { ...appState } : {};
			const { collaborators, ...rest } = clean;
			return rest;
		};

		const normalizeScene = (raw) => {
			if (!raw || typeof raw !== "object") return null;
			const elements = Array.isArray(raw.elements) ? raw.elements : [];
			const appState = normalizeAppStateForLoad(raw.appState);
			const files = raw.files && typeof raw.files === "object" ? raw.files : {};
			return { elements, appState, files };
		};

		const buildScenePayload = (elements, appState, files) => ({
			elements: Array.isArray(elements) ? elements : [],
			appState: prepareAppStateForSend(appState),
			files: files && typeof files === "object" ? files : {},
		});

		function safeParse(raw) {
			try {
				return JSON.parse(String(raw || ""));
			} catch {
				return null;
			}
		}

		function App() {
			const apiRef = useRef(null);
			const pendingSceneRef = useRef(null);
			const noteIdRef = useRef("");
			const lastSentRef = useRef("");

			useEffect(() => {
				const onMessage = (ev) => {
					const msg = ev && ev.data ? ev.data : null;
					if (!msg || msg.type !== "excalidraw_load_scene") return;
					noteIdRef.current = typeof msg.noteId === "string" ? msg.noteId : "";
					const parsed = normalizeScene(safeParse(msg.scene));
					if (!parsed) return;
					if (apiRef.current && apiRef.current.updateScene) {
						apiRef.current.updateScene(parsed);
						lastSentRef.current = JSON.stringify(
							buildScenePayload(parsed.elements, parsed.appState, parsed.files)
						);
					} else {
						pendingSceneRef.current = parsed;
					}
				};
				window.addEventListener("message", onMessage);
				return () => window.removeEventListener("message", onMessage);
			}, []);

			const handleChange = (elements, appState, files) => {
				const payload = JSON.stringify(
					buildScenePayload(elements, appState, files)
				);
				if (payload.length > MAX_BYTES) return;
				if (payload === lastSentRef.current) return;
				lastSentRef.current = payload;
				window.parent.postMessage(
					{
						type: "excalidraw_scene_change",
						noteId: noteIdRef.current,
						scene: payload,
					},
					"*"
				);
			};

			return React.createElement(Excalidraw, {
				excalidrawAPI: (api) => {
					apiRef.current = api;
					if (pendingSceneRef.current && apiRef.current.updateScene) {
						apiRef.current.updateScene(pendingSceneRef.current);
						lastSentRef.current = JSON.stringify(
							buildScenePayload(
								pendingSceneRef.current.elements,
								pendingSceneRef.current.appState,
								pendingSceneRef.current.files
							)
						);
						pendingSceneRef.current = null;
					}
				},
				onChange: handleChange,
				UIOptions: { canvasActions: { saveToActiveFile: false } },
			});
		}

		const root = createRoot(document.getElementById("root"));
		root.render(React.createElement(App));
	</script>
</body>
</html>
