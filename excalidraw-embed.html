<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Excalidraw Embed</title>
	<link
		rel="stylesheet"
		href="https://esm.sh/@excalidraw/excalidraw@0.17.6/dist/excalidraw.min.css"
	/>
	<style>
		html,
		body,
		#root {
			height: 100%;
			margin: 0;
			background: #0f172a;
		}
		body {
			overflow: hidden;
		}
		.excalidraw {
			background: #0f172a;
		}
	</style>
</head>
<body>
	<div id="root"></div>
	<script type="module">
		import React, { useEffect, useRef } from "https://esm.sh/react@18.2.0";
		import { createRoot } from "https://esm.sh/react-dom@18.2.0/client";
		import { Excalidraw } from "https://esm.sh/@excalidraw/excalidraw@0.17.6?dev=false&exports=Excalidraw";

		const MAX_BYTES = 200000;

		function safeParse(raw) {
			try {
				return JSON.parse(String(raw || ""));
			} catch {
				return null;
			}
		}

		function App() {
			const apiRef = useRef(null);
			const pendingSceneRef = useRef(null);
			const noteIdRef = useRef("");
			const lastSentRef = useRef("");

			useEffect(() => {
				const onMessage = (ev) => {
					const msg = ev && ev.data ? ev.data : null;
					if (!msg || msg.type !== "excalidraw_load_scene") return;
					noteIdRef.current = typeof msg.noteId === "string" ? msg.noteId : "";
					const data = safeParse(msg.scene);
					if (!data) return;
					if (apiRef.current && apiRef.current.updateScene) {
						apiRef.current.updateScene(data);
						lastSentRef.current = JSON.stringify(data);
					} else {
						pendingSceneRef.current = data;
					}
				};
				window.addEventListener("message", onMessage);
				return () => window.removeEventListener("message", onMessage);
			}, []);

			const handleChange = (elements, appState, files) => {
				const payload = JSON.stringify({ elements, appState, files });
				if (payload.length > MAX_BYTES) return;
				if (payload === lastSentRef.current) return;
				lastSentRef.current = payload;
				window.parent.postMessage(
					{
						type: "excalidraw_scene_change",
						noteId: noteIdRef.current,
						scene: payload,
					},
					"*"
				);
			};

			return (
				<Excalidraw
					excalidrawAPI={(api) => {
						apiRef.current = api;
						if (pendingSceneRef.current && apiRef.current.updateScene) {
							apiRef.current.updateScene(pendingSceneRef.current);
							lastSentRef.current = JSON.stringify(pendingSceneRef.current);
							pendingSceneRef.current = null;
						}
					}}
					onChange={handleChange}
					UIOptions={{ canvasActions: { saveToActiveFile: false } }}
				/>
			);
		}

		const root = createRoot(document.getElementById("root"));
		root.render(React.createElement(App));
	</script>
</body>
</html>
